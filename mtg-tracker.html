<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Commander Tracker</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Commander">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0a">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='90' fill='%230a0a0a'/%3E%3Ctext x='256' y='300' text-anchor='middle' font-size='260' fill='%23ffd700'%3E‚öî%3C/text%3E%3C/svg%3E">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='90' fill='%230a0a0a'/%3E%3Ctext x='256' y='300' text-anchor='middle' font-size='260' fill='%23ffd700'%3E‚öî%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Alegreya:wght@400;700&display=swap" rel="stylesheet">
<link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Commander%20Life%20Tracker%22%2C%22short_name%22%3A%22Commander%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a0a%22%2C%22theme_color%22%3A%22%230a0a0a%22%2C%22orientation%22%3A%22portrait%22%7D">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --p1: #c62828; --p1-dark: #4a0e0e;
    --p2: #1565c0; --p2-dark: #0a2a4a;
    --p3: #2e7d32; --p3-dark: #0e3311;
    --p4: #f9a825; --p4-dark: #4a3200;
    --bg: #0a0a0a;
    --overlay-bg: rgba(5,5,5,0.97);
    --text: #e0d6c8;
    --text-dim: #8a7f72;
    --poison: #7b1fa2;
    --commander-dmg: #d84315;
  }
  html, body {
    height: 100%; width: 100%; overflow: hidden;
    background: var(--bg);
    font-family: 'Alegreya', serif;
    color: var(--text);
    touch-action: manipulation;
    -webkit-user-select: none; user-select: none;
  }
  body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
  .game-board {
    display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
    height: 100vh; height: 100dvh; width: 100vw; gap: 3px;
    background: var(--bg); position: relative;
  }
  .center-orb {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    width: 52px; height: 52px;
    background: radial-gradient(circle, #1a1a1a 0%, #000 70%);
    border: 2px solid #333; border-radius: 50%;
    z-index: 10; display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 0 20px rgba(0,0,0,0.8); transition: all 0.3s;
  }
  .center-orb:hover { border-color: #666; }
  .center-orb svg { width: 24px; height: 24px; fill: #555; }
  .player-quad {
    position: relative; display: flex; flex-direction: column;
    align-items: center; justify-content: center; overflow: hidden;
  }
  .player-quad::before {
    content: ''; position: absolute; inset: 0; opacity: 0.07;
    background: radial-gradient(ellipse at center, var(--pc) 0%, transparent 70%);
    pointer-events: none;
  }
  .player-quad .card-bg {
    position: absolute; inset: 0; background-size: cover;
    background-position: center 20%; opacity: 0.13;
    pointer-events: none; transition: opacity 0.5s; filter: saturate(0.6);
  }
  .player-quad[data-seat="1"] { transform: rotate(180deg); background: var(--p1-dark); --pc: var(--p1); }
  .player-quad[data-seat="2"] { transform: rotate(180deg); background: var(--p2-dark); --pc: var(--p2); }
  .player-quad[data-seat="3"] { background: var(--p3-dark); --pc: var(--p3); }
  .player-quad[data-seat="4"] { background: var(--p4-dark); --pc: var(--p4); }
  .player-name {
    font-family: 'Cinzel', serif; font-size: 11px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase; color: var(--pc);
    opacity: 0.9; margin-bottom: 2px; position: relative; z-index: 1;
  }
  .commander-label {
    font-size: 9px; color: var(--text-dim); font-style: italic;
    margin-bottom: 4px; max-width: 90%; text-align: center;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    position: relative; z-index: 1; cursor: pointer;
    padding: 2px 8px; border-radius: 4px; transition: background 0.15s;
  }
  .commander-label:active { background: rgba(255,255,255,0.08); }
  .commander-label .edit-hint { font-size: 7px; opacity: 0.5; margin-left: 4px; }
  .color-pips { display: flex; gap: 3px; margin-bottom: 4px; position: relative; z-index: 1; }
  .mana-pip {
    width: 12px; height: 12px; border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.25); box-shadow: 0 1px 3px rgba(0,0,0,0.4);
  }
  .mana-W { background: linear-gradient(135deg, #f9faf4, #e8e4c9); }
  .mana-U { background: linear-gradient(135deg, #0e68ab, #4fa5d8); }
  .mana-B { background: linear-gradient(135deg, #2b2a2a, #5a5856); }
  .mana-R { background: linear-gradient(135deg, #d32029, #f56b42); }
  .mana-G { background: linear-gradient(135deg, #00733e, #4fad5b); }
  .life-total {
    font-family: 'Cinzel', serif; font-size: 64px; font-weight: 900;
    color: var(--text); text-shadow: 0 2px 8px rgba(0,0,0,0.6);
    line-height: 1; transition: color 0.3s, text-shadow 0.3s;
    position: relative; z-index: 1;
  }
  .life-total.danger { color: #ef5350; text-shadow: 0 0 20px rgba(239,83,80,0.4); }
  .life-total.critical { color: #f44336; text-shadow: 0 0 30px rgba(244,67,54,0.6); animation: pulse-critical 1s infinite; }
  @keyframes pulse-critical { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
  .life-controls {
    display: flex; align-items: center; gap: 12px;
    margin-top: 6px; position: relative; z-index: 1;
  }
  .life-btn {
    width: 44px; height: 44px; border-radius: 50%;
    border: 2px solid var(--pc); background: rgba(0,0,0,0.5);
    color: var(--pc); font-family: 'Cinzel', serif;
    font-size: 22px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .life-btn:active { background: var(--pc); color: #000; transform: scale(0.92); }
  .sub-counters {
    display: flex; gap: 10px; margin-top: 6px;
    position: relative; z-index: 1;
  }
  .sub-counter-btn {
    display: flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(0,0,0,0.4); color: var(--text-dim);
    font-size: 10px; font-family: 'Alegreya', serif;
    cursor: pointer; transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .sub-counter-btn:active { background: rgba(255,255,255,0.1); }
  .sub-counter-btn .count { color: var(--text); font-weight: 700; font-size: 12px; }
  .sub-counter-btn.poison .count { color: var(--poison); }
  .sub-counter-btn svg { width: 12px; height: 12px; fill: currentColor; }

  /* ========== OVERLAYS ========== */
  .overlay {
    position: fixed; inset: 0; background: var(--overlay-bg);
    z-index: 100; display: none; flex-direction: column;
    padding: 20px; overflow-y: auto; animation: fadeIn 0.2s ease;
  }
  .overlay.active { display: flex; }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  .overlay-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 20px; padding-bottom: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .overlay-title { font-family: 'Cinzel', serif; font-size: 18px; font-weight: 700; letter-spacing: 1px; }
  .close-btn {
    width: 36px; height: 36px; border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.15);
    background: transparent; color: var(--text);
    font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer;
  }
  .cmdr-dmg-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .cmdr-dmg-label { font-size: 13px; color: var(--text-dim); flex: 1; }
  .cmdr-dmg-label strong { color: var(--text); }
  .cmdr-dmg-controls { display: flex; align-items: center; gap: 10px; }
  .cmdr-dmg-val {
    font-family: 'Cinzel', serif; font-size: 22px; font-weight: 700;
    min-width: 36px; text-align: center; color: var(--commander-dmg);
  }
  .cmdr-dmg-val.lethal { color: #f44336; text-shadow: 0 0 10px rgba(244,67,54,0.5); }
  .mini-btn {
    width: 34px; height: 34px; border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05); color: var(--text);
    font-size: 18px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }
  .mini-btn:active { background: rgba(255,255,255,0.15); }
  .poison-display { text-align: center; padding: 30px 0; }
  .poison-val {
    font-family: 'Cinzel', serif; font-size: 72px; font-weight: 900;
    color: var(--poison); text-shadow: 0 0 40px rgba(123,31,162,0.3);
  }
  .poison-val.lethal { color: #e040fb; text-shadow: 0 0 40px rgba(224,64,251,0.5); animation: pulse-critical 1s infinite; }
  .poison-controls {
    display: flex; align-items: center; justify-content: center; gap: 20px; margin-top: 16px;
  }
  .poison-btn {
    width: 52px; height: 52px; border-radius: 50%;
    border: 2px solid var(--poison); background: rgba(123,31,162,0.15);
    color: #ce93d8; font-size: 26px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }
  .poison-btn:active { background: var(--poison); color: #fff; }

  /* ========== SCRYFALL SEARCH ========== */
  .cmdr-search-overlay {
    position: fixed; inset: 0; background: var(--overlay-bg);
    z-index: 150; display: none; flex-direction: column; animation: fadeIn 0.2s ease;
  }
  .cmdr-search-overlay.active { display: flex; }
  .cmdr-search-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .cmdr-search-header .top-row {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
  }
  .cmdr-search-for {
    font-family: 'Cinzel', serif; font-size: 12px;
    letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-dim);
  }
  .search-input-wrap { position: relative; }
  .search-input-wrap input {
    width: 100%; padding: 12px 16px 12px 42px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06);
    color: var(--text); font-family: 'Alegreya', serif; font-size: 16px;
    outline: none; transition: border-color 0.2s;
    -webkit-user-select: text; user-select: text;
  }
  .search-input-wrap input:focus { border-color: rgba(255,255,255,0.35); }
  .search-input-wrap input::placeholder { color: rgba(255,255,255,0.2); }
  .search-icon {
    position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
    width: 18px; height: 18px; fill: var(--text-dim); pointer-events: none;
  }
  .search-results { flex: 1; overflow-y: auto; padding: 8px 12px; -webkit-overflow-scrolling: touch; }
  .search-loading { text-align: center; padding: 40px 20px; color: var(--text-dim); font-size: 14px; }
  .search-loading .spinner {
    display: inline-block; width: 24px; height: 24px;
    border: 2px solid rgba(255,255,255,0.1); border-top-color: var(--text-dim);
    border-radius: 50%; animation: spin 0.7s linear infinite; margin-bottom: 10px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .search-empty { text-align: center; padding: 50px 20px; color: var(--text-dim); }
  .search-empty .big-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.3; }
  .card-result {
    display: flex; align-items: center; gap: 14px;
    padding: 10px 12px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.05);
    background: rgba(255,255,255,0.02); margin-bottom: 8px;
    cursor: pointer; transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .card-result:active, .card-result:hover {
    background: rgba(255,255,255,0.07); border-color: rgba(255,255,255,0.15);
  }
  .card-art {
    width: 52px; height: 72px; border-radius: 6px; overflow: hidden;
    flex-shrink: 0; background: rgba(255,255,255,0.05);
  }
  .card-art img { width: 100%; height: 100%; object-fit: cover; }
  .card-info { flex: 1; min-width: 0; }
  .card-info-name {
    font-family: 'Cinzel', serif; font-size: 14px; font-weight: 700;
    color: var(--text); margin-bottom: 3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .card-info-type {
    font-size: 11px; color: var(--text-dim); margin-bottom: 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .card-info-colors { display: flex; gap: 3px; }
  .card-info-colors .mana-pip { width: 14px; height: 14px; }
  .card-info-mana { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .card-select-arrow { color: var(--text-dim); font-size: 18px; flex-shrink: 0; }
  .current-cmdr {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 20px; background: rgba(255,215,0,0.05);
    border-bottom: 1px solid rgba(255,215,0,0.1);
  }
  .current-cmdr .card-art { width: 40px; height: 56px; }
  .current-cmdr-info { flex: 1; }
  .current-cmdr-label {
    font-size: 9px; text-transform: uppercase;
    letter-spacing: 1.5px; color: var(--text-dim); margin-bottom: 2px;
  }
  .current-cmdr-name { font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700; color: #ffd700; }
  .remove-cmdr-btn {
    padding: 6px 12px; border-radius: 8px;
    border: 1px solid rgba(239,83,80,0.3); background: rgba(239,83,80,0.1);
    color: #ef5350; font-size: 11px; font-family: 'Alegreya', serif; cursor: pointer;
  }

  /* ========== SETTINGS ========== */
  .settings-section { margin-bottom: 24px; }
  .settings-section h3 {
    font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700;
    letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 12px;
  }
  .player-setting-card {
    padding: 12px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.02); margin-bottom: 8px;
  }
  .player-setting-top {
    display: flex; align-items: center; gap: 12px;
  }
  .player-setting-color { width: 8px; height: 48px; border-radius: 4px; flex-shrink: 0; }
  .player-setting-fields { flex: 1; display: flex; flex-direction: column; gap: 6px; }
  .player-setting-fields input {
    width: 100%; padding: 6px 10px; border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.04);
    color: var(--text); font-family: 'Alegreya', serif; font-size: 13px;
    outline: none; -webkit-user-select: text; user-select: text;
  }
  .player-setting-fields input:focus { border-color: rgba(255,255,255,0.25); }
  .player-setting-cmdr-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 12px; border-radius: 8px;
    border: 1px dashed rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.02); color: var(--text-dim);
    font-size: 12px; font-family: 'Alegreya', serif;
    cursor: pointer; transition: all 0.15s; width: 100%; text-align: left;
  }
  .player-setting-cmdr-btn:active { background: rgba(255,255,255,0.06); }
  .player-setting-cmdr-btn.has-cmdr {
    border-style: solid; border-color: rgba(255,215,0,0.2); color: var(--text);
  }
  .player-setting-cmdr-btn .cmdr-thumb {
    width: 24px; height: 34px; border-radius: 3px; object-fit: cover; flex-shrink: 0;
  }

  /* Saved players chips */
  .saved-players-row {
    display: flex; flex-wrap: wrap; gap: 6px;
    margin-top: 8px; padding-left: 20px;
  }
  .saved-player-chip {
    padding: 4px 12px; border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.04);
    color: var(--text-dim); font-size: 12px;
    font-family: 'Alegreya', serif;
    cursor: pointer; transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .saved-player-chip:active {
    background: rgba(255,215,0,0.15); border-color: rgba(255,215,0,0.3); color: #ffd700;
  }
  .saved-player-chip.active-seat {
    background: rgba(255,215,0,0.1); border-color: rgba(255,215,0,0.25); color: #ffd700;
  }
  .saved-player-chip.taken {
    opacity: 0.3; pointer-events: none;
  }

  /* Manage saved players overlay */
  .manage-players-section {
    margin-top: 8px;
  }
  .manage-player-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.04);
    background: rgba(255,255,255,0.02); margin-bottom: 4px;
  }
  .manage-player-name { font-size: 14px; color: var(--text); }
  .manage-player-games { font-size: 11px; color: var(--text-dim); margin-left: 8px; }
  .manage-player-remove {
    background: none; border: none; color: #ef5350;
    font-size: 18px; cursor: pointer; padding: 4px 8px;
    opacity: 0.6; transition: opacity 0.15s;
  }
  .manage-player-remove:active { opacity: 1; }
  .add-player-row {
    display: flex; gap: 8px; margin-top: 8px;
  }
  .add-player-row input {
    flex: 1; padding: 8px 12px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04);
    color: var(--text); font-family: 'Alegreya', serif; font-size: 13px;
    outline: none; -webkit-user-select: text; user-select: text;
  }
  .add-player-btn {
    padding: 8px 16px; border-radius: 8px; border: none;
    background: rgba(255,215,0,0.15); color: #ffd700;
    font-family: 'Cinzel', serif; font-size: 12px; font-weight: 700;
    cursor: pointer;
  }
  .add-player-btn:active { opacity: 0.8; }

  .sheets-link-section { margin-bottom: 8px; }
  .sheets-link-wrap { display: flex; gap: 8px; align-items: center; }
  .sheets-link-wrap input {
    flex: 1; padding: 10px 12px; border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04);
    color: var(--text); font-family: 'Alegreya', serif; font-size: 12px;
    outline: none; -webkit-user-select: text; user-select: text;
  }
  .sheets-link-wrap input:focus { border-color: rgba(76,175,80,0.5); }
  .sheets-link-wrap input::placeholder { color: rgba(255,255,255,0.15); font-size: 11px; }
  .sheets-link-status { font-size: 11px; margin-top: 6px; color: var(--text-dim); line-height: 1.4; }
  .sheets-link-status.linked { color: #66bb6a; }
  .sheets-save-btn {
    padding: 10px 16px; border-radius: 8px; border: none;
    background: #1b7a3d; color: #fff;
    font-family: 'Alegreya', serif; font-size: 13px; font-weight: 700;
    cursor: pointer; white-space: nowrap;
  }
  .sheets-save-btn:active { opacity: 0.8; }
  .action-btn {
    display: block; width: 100%; padding: 14px; border-radius: 10px; border: none;
    font-family: 'Cinzel', serif; font-size: 14px; font-weight: 700;
    letter-spacing: 1px; cursor: pointer; margin-bottom: 10px;
    transition: all 0.15s; -webkit-tap-highlight-color: transparent;
  }
  .action-btn:active { transform: scale(0.98); }
  .btn-reset { background: rgba(244,67,54,0.15); color: #ef5350; border: 1px solid rgba(244,67,54,0.3); }
  .btn-winner { background: rgba(255,215,0,0.15); color: #ffd700; border: 1px solid rgba(255,215,0,0.3); }

  .install-hint {
    padding: 10px 16px; background: rgba(255,215,0,0.06);
    border: 1px solid rgba(255,215,0,0.12); border-radius: 10px;
    font-size: 12px; color: var(--text-dim); line-height: 1.5; margin-bottom: 16px;
  }
  .install-hint strong { color: #ffd700; }
  .install-hint-dismiss {
    background: none; border: none; color: var(--text-dim);
    font-size: 11px; text-decoration: underline; cursor: pointer; margin-top: 4px; display: block;
  }

  /* ========== WINNER MODAL ========== */
  .winner-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.92);
    z-index: 200; display: none; flex-direction: column;
    align-items: center; justify-content: center; padding: 30px;
    overflow-y: auto;
  }
  .winner-modal.active { display: flex; }
  .winner-modal h2 {
    font-family: 'Cinzel', serif; font-size: 14px;
    letter-spacing: 3px; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 20px;
  }
  .winner-options {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 12px; width: 100%; max-width: 320px; margin-bottom: 24px;
  }
  .winner-opt {
    padding: 14px 10px; border-radius: 12px;
    border: 2px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.03); color: var(--text);
    font-family: 'Cinzel', serif; font-size: 12px; font-weight: 700;
    text-align: center; cursor: pointer; transition: all 0.15s;
  }
  .winner-opt .winner-opt-cmdr {
    font-family: 'Alegreya', serif; font-size: 10px; font-weight: 400;
    color: var(--text-dim); margin-top: 4px; font-style: italic;
  }
  .winner-opt:active, .winner-opt.selected {
    border-color: #ffd700; background: rgba(255,215,0,0.1); color: #ffd700;
  }
  .win-condition-section {
    width: 100%; max-width: 320px; margin-bottom: 24px; display: none;
  }
  .win-condition-section.visible { display: block; }
  .win-condition-label {
    font-family: 'Cinzel', serif; font-size: 11px;
    letter-spacing: 2px; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 10px; text-align: center;
  }
  .win-conditions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .win-cond-opt {
    padding: 10px 8px; border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02); color: var(--text-dim);
    font-family: 'Alegreya', serif; font-size: 12px;
    text-align: center; cursor: pointer; transition: all 0.15s;
  }
  .win-cond-opt .wc-icon { font-size: 18px; display: block; margin-bottom: 4px; }
  .win-cond-opt:active, .win-cond-opt.selected {
    border-color: #ffd700; background: rgba(255,215,0,0.08); color: #ffd700;
  }
  .winner-confirm {
    padding: 14px 40px; border-radius: 10px;
    border: 2px solid #ffd700; background: rgba(255,215,0,0.15);
    color: #ffd700; font-family: 'Cinzel', serif;
    font-size: 14px; font-weight: 700; letter-spacing: 1px;
    cursor: pointer; display: none;
  }
  .winner-confirm.visible { display: block; }
  .winner-cancel {
    margin-top: 16px; background: none; border: none;
    color: var(--text-dim); font-family: 'Alegreya', serif;
    font-size: 14px; cursor: pointer; text-decoration: underline;
  }

  /* ========== EXPORT MODAL ========== */
  .export-modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.95);
    z-index: 250; display: none; flex-direction: column;
    align-items: center; justify-content: center; padding: 30px;
  }
  .export-modal.active { display: flex; }
  .export-modal .export-icon { font-size: 48px; margin-bottom: 16px; }
  .export-modal h2 {
    font-family: 'Cinzel', serif; font-size: 16px; font-weight: 700;
    color: #ffd700; margin-bottom: 8px; text-align: center;
  }
  .export-modal .export-subtitle {
    color: var(--text-dim); font-size: 14px; text-align: center; margin-bottom: 24px;
    max-width: 280px; line-height: 1.5;
  }
  .export-actions { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 300px; }
  .export-btn {
    padding: 14px 20px; border-radius: 10px; border: none;
    font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700;
    letter-spacing: 0.5px; cursor: pointer; text-align: center;
    transition: all 0.15s; display: flex; align-items: center;
    justify-content: center; gap: 8px; -webkit-tap-highlight-color: transparent;
  }
  .export-btn:active { transform: scale(0.97); }
  .export-btn-primary { background: #1b7a3d; color: #fff; }
  .export-btn-secondary {
    background: rgba(255,255,255,0.06); color: var(--text);
    border: 1px solid rgba(255,255,255,0.12);
  }
  .export-btn-close {
    background: transparent; color: var(--text-dim);
    border: 1px solid rgba(255,255,255,0.08); margin-top: 6px;
  }
  .export-status {
    margin-top: 12px; font-size: 12px; color: var(--text-dim); text-align: center;
    min-height: 18px; line-height: 1.4;
  }
  .export-status.success { color: #66bb6a; }

  .toast {
    position: fixed; bottom: 30px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: #1b5e20; color: #fff;
    padding: 12px 24px; border-radius: 10px;
    font-family: 'Alegreya', serif; font-size: 14px;
    z-index: 300; opacity: 0; transition: all 0.3s ease;
    pointer-events: none; white-space: nowrap; max-width: 90%; text-align: center;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .history-log {
    max-height: 200px; overflow-y: auto;
    background: rgba(0,0,0,0.3); border-radius: 8px;
    padding: 10px; margin-top: 12px;
    font-size: 11px; color: var(--text-dim); line-height: 1.6;
  }
</style>
</head>
<body>

<div class="game-board" id="gameBoard"></div>

<div class="overlay" id="cmdrDmgOverlay">
  <div class="overlay-header">
    <span class="overlay-title" id="cmdrDmgTitle">Commander Damage</span>
    <button class="close-btn" onclick="closeOverlay('cmdrDmgOverlay')">‚úï</button>
  </div>
  <div id="cmdrDmgContent"></div>
</div>

<div class="overlay" id="poisonOverlay">
  <div class="overlay-header">
    <span class="overlay-title" id="poisonTitle">Poison Counters</span>
    <button class="close-btn" onclick="closeOverlay('poisonOverlay')">‚úï</button>
  </div>
  <div id="poisonContent"></div>
</div>

<div class="overlay" id="settingsOverlay">
  <div class="overlay-header">
    <span class="overlay-title">‚öô Game Settings</span>
    <button class="close-btn" onclick="closeOverlay('settingsOverlay')">‚úï</button>
  </div>
  <div id="settingsContent"></div>
</div>

<div class="cmdr-search-overlay" id="cmdrSearchOverlay">
  <div class="cmdr-search-header">
    <div class="top-row">
      <span class="cmdr-search-for" id="cmdrSearchFor">Select Commander</span>
      <button class="close-btn" onclick="closeCmdrSearch()">‚úï</button>
    </div>
    <div class="search-input-wrap">
      <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
      <input type="text" id="cmdrSearchInput" placeholder="Search for a legendary creature‚Ä¶" autocomplete="off" autocorrect="off" spellcheck="false">
    </div>
  </div>
  <div id="cmdrCurrentBanner"></div>
  <div class="search-results" id="cmdrSearchResults">
    <div class="search-empty"><div class="big-icon">‚öî</div><div>Type a commander name to search Scryfall</div></div>
  </div>
</div>

<div class="winner-modal" id="winnerModal">
  <h2>Declare the Victor</h2>
  <div class="winner-options" id="winnerOptions"></div>
  <div class="win-condition-section" id="winConditionSection">
    <div class="win-condition-label">How did they win?</div>
    <div class="win-conditions-grid" id="winConditionsGrid"></div>
  </div>
  <button class="winner-confirm" id="winnerConfirm" onclick="confirmWinner()">Crown Winner</button>
  <button class="winner-cancel" onclick="closeWinnerModal()">Cancel</button>
</div>

<div class="export-modal" id="exportModal">
  <div class="export-icon">üèÜ</div>
  <h2 id="exportWinnerName">Winner!</h2>
  <div class="export-subtitle" id="exportSubtitle">Game data is ready to export</div>
  <div class="export-actions">
    <button class="export-btn export-btn-primary" onclick="exportToLinkedSheet()">
      <span>üìã</span> <span id="exportPrimaryLabel">Copy &amp; Open Google Sheets</span>
    </button>
    <button class="export-btn export-btn-secondary" onclick="exportDownloadCSV()">
      <span>üíæ</span> Download CSV File
    </button>
    <button class="export-btn export-btn-close" onclick="closeExportModal()">Done</button>
  </div>
  <div class="export-status" id="exportStatus"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============ PERSISTENCE ============
const SK = {
  sheetsUrl: 'cmdr_sheets_url',
  roster: 'cmdr_player_roster',
  installDismissed: 'cmdr_install_dismissed',
};

function loadSaved(key, fallback) {
  try { const v = localStorage.getItem(key); return v !== null ? JSON.parse(v) : fallback; }
  catch { return fallback; }
}
function save(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
}

let sheetsUrl = loadSaved(SK.sheetsUrl, '');
// Roster: array of { name: string, games: number }
let playerRoster = loadSaved(SK.roster, []);
const installDismissed = loadSaved(SK.installDismissed, false);

function saveRoster() { save(SK.roster, playerRoster); }

function addToRoster(name) {
  if (!name || name.match(/^Player \d+$/)) return; // Don't save defaults
  const existing = playerRoster.find(p => p.name.toLowerCase() === name.toLowerCase());
  if (existing) {
    existing.name = name; // preserve casing of latest
  } else {
    playerRoster.push({ name, games: 0 });
  }
  saveRoster();
}

function incrementRosterGames(name) {
  const p = playerRoster.find(r => r.name.toLowerCase() === name.toLowerCase());
  if (p) p.games++;
  saveRoster();
}

function removeFromRoster(name) {
  playerRoster = playerRoster.filter(p => p.name !== name);
  saveRoster();
}

// ============ STATE ============
const STARTING_LIFE = 40;
const COLORS = [
  { name: 'Crimson', hex: '#c62828' },
  { name: 'Sapphire', hex: '#1565c0' },
  { name: 'Emerald', hex: '#2e7d32' },
  { name: 'Gold', hex: '#f9a825' },
];
const WIN_CONDITIONS = [
  { id: 'combat', label: 'Combat Damage', icon: '‚öîÔ∏è' },
  { id: 'commander', label: 'Commander Damage', icon: 'üëë' },
  { id: 'combo', label: 'Combo', icon: '‚ôæÔ∏è' },
  { id: 'burn', label: 'Burn / Direct', icon: 'üî•' },
  { id: 'drain', label: 'Drain / Life Loss', icon: 'ü©∏' },
  { id: 'mill', label: 'Mill / Decking', icon: 'üìö' },
  { id: 'poison', label: 'Poison / Infect', icon: '‚ò†Ô∏è' },
  { id: 'alt_win', label: '"I Win" Card', icon: 'üåü' },
  { id: 'concede', label: 'Concession', icon: 'üè≥Ô∏è' },
  { id: 'other', label: 'Other', icon: '‚ú®' },
];

let gameState = {
  players: [
    { name: 'Player 1', commander: '', commanderData: null, life: STARTING_LIFE, poison: 0, cmdrDmg: [0,0,0,0] },
    { name: 'Player 2', commander: '', commanderData: null, life: STARTING_LIFE, poison: 0, cmdrDmg: [0,0,0,0] },
    { name: 'Player 3', commander: '', commanderData: null, life: STARTING_LIFE, poison: 0, cmdrDmg: [0,0,0,0] },
    { name: 'Player 4', commander: '', commanderData: null, life: STARTING_LIFE, poison: 0, cmdrDmg: [0,0,0,0] },
  ],
  history: [],
  startTime: new Date().toISOString(),
  winner: null,
  winCondition: null,
};

let exportRowTSV = '';
let exportFullCSV = '';

function logEvent(msg) { gameState.history.push({ time: new Date().toLocaleTimeString(), msg }); }

// ============ SCRYFALL ============
let searchTimeout = null;
let currentSearchPlayerIdx = null;
let searchResultsCache = [];
let cmdrSearchOpenedFromSettings = false;

function openCmdrSearch(playerIdx, fromSettings) {
  currentSearchPlayerIdx = playerIdx;
  cmdrSearchOpenedFromSettings = !!fromSettings;
  const p = gameState.players[playerIdx];
  document.getElementById('cmdrSearchFor').textContent = `Commander for ${p.name}`;
  document.getElementById('cmdrSearchInput').value = '';
  renderCurrentCmdrBanner(playerIdx);
  document.getElementById('cmdrSearchResults').innerHTML = `
    <div class="search-empty"><div class="big-icon">‚öî</div><div>Type a commander name to search Scryfall</div></div>`;
  document.getElementById('cmdrSearchOverlay').classList.add('active');
  setTimeout(() => document.getElementById('cmdrSearchInput').focus(), 300);
}

function renderCurrentCmdrBanner(playerIdx) {
  const p = gameState.players[playerIdx];
  const banner = document.getElementById('cmdrCurrentBanner');
  if (!p.commanderData) { banner.innerHTML = ''; return; }
  const art = getCardImage(p.commanderData, 'small');
  banner.innerHTML = `
    <div class="current-cmdr">
      <div class="card-art"><img src="${art}" alt="" loading="lazy"></div>
      <div class="current-cmdr-info">
        <div class="current-cmdr-label">Current Commander</div>
        <div class="current-cmdr-name">${esc(p.commander)}</div>
      </div>
      <button class="remove-cmdr-btn" onclick="removeCommander(${playerIdx})">Remove</button>
    </div>`;
}

function removeCommander(playerIdx) {
  gameState.players[playerIdx].commander = '';
  gameState.players[playerIdx].commanderData = null;
  renderCurrentCmdrBanner(playerIdx);
  renderBoard();
  if (document.getElementById('settingsOverlay').classList.contains('active')) openSettings();
}

function closeCmdrSearch() {
  document.getElementById('cmdrSearchOverlay').classList.remove('active');
  if (cmdrSearchOpenedFromSettings) openSettings();
  currentSearchPlayerIdx = null;
  cmdrSearchOpenedFromSettings = false;
}

document.getElementById('cmdrSearchInput').addEventListener('input', function() {
  clearTimeout(searchTimeout);
  const query = this.value.trim();
  if (query.length < 2) {
    document.getElementById('cmdrSearchResults').innerHTML = `
      <div class="search-empty"><div class="big-icon">‚öî</div><div>Type at least 2 characters to search</div></div>`;
    return;
  }
  document.getElementById('cmdrSearchResults').innerHTML = `
    <div class="search-loading"><div class="spinner"></div><div>Searching Scryfall‚Ä¶</div></div>`;
  searchTimeout = setTimeout(() => scryfallSearch(query), 350);
});

async function scryfallSearch(query) {
  try {
    const resp = await fetch(`https://api.scryfall.com/cards/search?q=${encodeURIComponent(query + ' is:commander')}&order=edhrec&unique=cards`);
    if (!resp.ok) {
      if (resp.status === 404) {
        document.getElementById('cmdrSearchResults').innerHTML = `
          <div class="search-empty"><div class="big-icon">üîç</div>
          <div>No commanders found for "${esc(query)}"</div></div>`;
        return;
      }
      throw new Error('API error');
    }
    const data = await resp.json();
    searchResultsCache = data.data.slice(0, 20);
    renderSearchResults(searchResultsCache);
  } catch {
    document.getElementById('cmdrSearchResults').innerHTML = `
      <div class="search-empty"><div class="big-icon">‚ö†</div><div>Search failed ‚Äî check connection</div></div>`;
  }
}

function getCardImage(card, size) {
  if (card.image_uris) return card.image_uris[size] || card.image_uris.small;
  if (card.card_faces?.[0]?.image_uris) return card.card_faces[0].image_uris[size] || card.card_faces[0].image_uris.small;
  return '';
}
function getCardArtCrop(card) {
  if (card.image_uris) return card.image_uris.art_crop || card.image_uris.normal || '';
  if (card.card_faces?.[0]?.image_uris) return card.card_faces[0].image_uris.art_crop || card.card_faces[0].image_uris.normal || '';
  return '';
}
function getManaCost(card) { return card.mana_cost || card.card_faces?.[0]?.mana_cost || ''; }

function renderSearchResults(cards) {
  const container = document.getElementById('cmdrSearchResults');
  if (!cards.length) {
    container.innerHTML = `<div class="search-empty"><div class="big-icon">üîç</div><div>No commanders found</div></div>`;
    return;
  }
  container.innerHTML = cards.map((card, idx) => {
    const img = getCardImage(card, 'small');
    const colors = card.color_identity || [];
    const pips = colors.map(c => `<div class="mana-pip mana-${c}"></div>`).join('');
    const artHtml = img ? `<img src="${img}" alt="" loading="lazy">` : '';
    const mc = getManaCost(card);
    return `
      <div class="card-result" onclick="selectCommanderByIndex(${idx})">
        <div class="card-art">${artHtml}</div>
        <div class="card-info">
          <div class="card-info-name">${esc(card.name)}</div>
          <div class="card-info-type">${esc(card.type_line || '')}</div>
          <div class="card-info-colors">${pips}</div>
          ${mc ? `<div class="card-info-mana">${formatManaCost(mc)}</div>` : ''}
        </div>
        <div class="card-select-arrow">‚Ä∫</div>
      </div>`;
  }).join('');
}

function formatManaCost(cost) {
  return esc(cost).replace(/\{([^}]+)\}/g, (_, sym) => {
    const s = sym.toUpperCase();
    const bg = { W:'#f9faf4', U:'#0e68ab', B:'#2b2a2a', R:'#d32029', G:'#00733e' }[s] || '#888';
    const fg = s === 'W' ? '#333' : '#fff';
    return `<span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:${bg};color:${fg};font-size:9px;font-weight:700;text-align:center;line-height:16px;margin:0 1px;border:1px solid rgba(0,0,0,0.2)">${s}</span>`;
  });
}

function selectCommanderByIndex(idx) {
  const card = searchResultsCache[idx];
  if (!card || currentSearchPlayerIdx === null) return;
  const p = gameState.players[currentSearchPlayerIdx];
  p.commander = card.name;
  p.commanderData = card;
  logEvent(`${p.name} selected commander: ${card.name}`);
  renderBoard();
  document.getElementById('cmdrSearchOverlay').classList.remove('active');
  if (cmdrSearchOpenedFromSettings) openSettings();
  currentSearchPlayerIdx = null;
  cmdrSearchOpenedFromSettings = false;
  showToast(`${card.name} selected!`);
}

// ============ RENDER BOARD ============
function renderBoard() {
  const board = document.getElementById('gameBoard');
  board.innerHTML = '';
  gameState.players.forEach((p, i) => {
    const quad = document.createElement('div');
    quad.className = 'player-quad';
    quad.dataset.seat = i + 1;
    const lifeClass = p.life <= 0 ? 'critical' : p.life <= 10 ? 'danger' : '';
    const totalCmdrDmg = p.cmdrDmg.reduce((a, b) => a + b, 0);
    let bgStyle = '';
    if (p.commanderData) {
      const art = getCardArtCrop(p.commanderData);
      if (art) bgStyle = `background-image: url('${art}')`;
    }
    const colorPips = p.commanderData?.color_identity
      ? p.commanderData.color_identity.map(c => `<div class="mana-pip mana-${c}"></div>`).join('') : '';
    const pipsHtml = colorPips ? `<div class="color-pips">${colorPips}</div>` : '';
    const cmdrLabel = p.commander ? esc(p.commander) : 'Tap to set commander';
    quad.innerHTML = `
      <div class="card-bg" style="${bgStyle}"></div>
      <div class="player-name">${esc(p.name)}</div>
      ${pipsHtml}
      <div class="commander-label" onclick="openCmdrSearch(${i}, false)">${cmdrLabel}<span class="edit-hint"> ‚úé</span></div>
      <div class="life-total ${lifeClass}">${p.life}</div>
      <div class="life-controls">
        <button class="life-btn" onclick="changeLife(${i},-1)">‚àí</button>
        <button class="life-btn" onclick="changeLife(${i},1)">+</button>
      </div>
      <div class="sub-counters">
        <button class="sub-counter-btn" onclick="openCmdrDmg(${i})">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          <span>Cmdr</span><span class="count">${totalCmdrDmg}</span>
        </button>
        <button class="sub-counter-btn poison" onclick="openPoison(${i})">
          <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          <span>Poison</span><span class="count">${p.poison}</span>
        </button>
      </div>`;
    board.appendChild(quad);
  });
  const orb = document.createElement('div');
  orb.className = 'center-orb';
  orb.onclick = openSettings;
  orb.innerHTML = `<svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.49.49 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.49.49 0 00-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6A3.6 3.6 0 1112 8.4a3.6 3.6 0 010 7.2z"/></svg>`;
  board.appendChild(orb);
}

function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

// ============ LIFE ============
function changeLife(idx, delta) {
  gameState.players[idx].life += delta;
  logEvent(`${gameState.players[idx].name}: ${delta > 0 ? '+' : ''}${delta} ‚Üí ${gameState.players[idx].life}`);
  renderBoard(); haptic();
}
function haptic() { if (navigator.vibrate) navigator.vibrate(15); }

// ============ COMMANDER DAMAGE ============
function openCmdrDmg(playerIdx) {
  const p = gameState.players[playerIdx];
  document.getElementById('cmdrDmgTitle').textContent = `${p.name} ‚Äî Cmdr Damage Taken`;
  let html = '';
  gameState.players.forEach((src, srcIdx) => {
    if (srcIdx === playerIdx) return;
    const val = p.cmdrDmg[srcIdx];
    const cmdName = src.commander || src.name;
    html += `
      <div class="cmdr-dmg-row">
        <div class="cmdr-dmg-label">From <strong style="color:${COLORS[srcIdx].hex}">${esc(cmdName)}</strong></div>
        <div class="cmdr-dmg-controls">
          <button class="mini-btn" onclick="changeCmdrDmg(${playerIdx},${srcIdx},-1)">‚àí</button>
          <span class="cmdr-dmg-val${val >= 21 ? ' lethal' : ''}" id="cdv-${playerIdx}-${srcIdx}">${val}</span>
          <button class="mini-btn" onclick="changeCmdrDmg(${playerIdx},${srcIdx},1)">+</button>
        </div>
      </div>`;
  });
  document.getElementById('cmdrDmgContent').innerHTML = html;
  document.getElementById('cmdrDmgOverlay').classList.add('active');
}

function changeCmdrDmg(targetIdx, srcIdx, delta) {
  const p = gameState.players[targetIdx];
  const newVal = Math.max(0, p.cmdrDmg[srcIdx] + delta);
  const actual = newVal - p.cmdrDmg[srcIdx];
  p.cmdrDmg[srcIdx] = newVal;
  p.life -= actual;
  if (actual !== 0) logEvent(`${p.name}: ${actual > 0 ? '+' : ''}${actual} cmdr dmg from ${gameState.players[srcIdx].commander || gameState.players[srcIdx].name} (life ‚Üí ${p.life})`);
  const el = document.getElementById(`cdv-${targetIdx}-${srcIdx}`);
  if (el) { el.textContent = p.cmdrDmg[srcIdx]; el.className = 'cmdr-dmg-val' + (p.cmdrDmg[srcIdx] >= 21 ? ' lethal' : ''); }
  renderBoard(); haptic();
}

// ============ POISON ============
function openPoison(playerIdx) {
  const p = gameState.players[playerIdx];
  document.getElementById('poisonTitle').textContent = `${p.name} ‚Äî Poison Counters`;
  document.getElementById('poisonContent').innerHTML = `
    <div class="poison-display">
      <div class="poison-val${p.poison >= 10 ? ' lethal' : ''}" id="pv-${playerIdx}">${p.poison}</div>
      <div class="poison-controls">
        <button class="poison-btn" onclick="changePoison(${playerIdx},-1)">‚àí</button>
        <button class="poison-btn" onclick="changePoison(${playerIdx},1)">+</button>
      </div>
      <div style="margin-top:20px;color:var(--text-dim);font-size:13px;" id="poison-info-${playerIdx}">
        ${p.poison >= 10 ? '‚ò† LETHAL ‚Äî 10 or more poison counters!' : `${10 - p.poison} until lethal`}
      </div>
    </div>`;
  document.getElementById('poisonOverlay').classList.add('active');
}

function changePoison(playerIdx, delta) {
  const p = gameState.players[playerIdx];
  p.poison = Math.max(0, p.poison + delta);
  logEvent(`${p.name}: poison ‚Üí ${p.poison}`);
  const el = document.getElementById(`pv-${playerIdx}`);
  if (el) { el.textContent = p.poison; el.className = 'poison-val' + (p.poison >= 10 ? ' lethal' : ''); }
  const info = document.getElementById(`poison-info-${playerIdx}`);
  if (info) info.innerHTML = p.poison >= 10 ? '‚ò† LETHAL ‚Äî 10 or more poison counters!' : `${10 - p.poison} until lethal`;
  renderBoard(); haptic();
}

// ============ SETTINGS ============
function openSettings() {
  // Current seat names for "taken" detection
  const seatNames = gameState.players.map(p => p.name.toLowerCase());

  let cards = '';
  gameState.players.forEach((p, i) => {
    const thumb = p.commanderData ? getCardImage(p.commanderData, 'small') : '';
    const cmdrContent = p.commander
      ? `${thumb ? `<img class="cmdr-thumb" src="${thumb}" alt="">` : ''}${esc(p.commander)}`
      : `‚öî Search Scryfall‚Ä¶`;

    // Build saved player chips for this seat
    const sortedRoster = [...playerRoster].sort((a, b) => b.games - a.games);
    let chipsHtml = '';
    if (sortedRoster.length > 0) {
      const chips = sortedRoster.map(rp => {
        const isCurrentSeat = rp.name.toLowerCase() === p.name.toLowerCase();
        const isTaken = !isCurrentSeat && seatNames.includes(rp.name.toLowerCase());
        let cls = 'saved-player-chip';
        if (isCurrentSeat) cls += ' active-seat';
        if (isTaken) cls += ' taken';
        const gamesLabel = rp.games > 0 ? ` (${rp.games})` : '';
        return `<button class="${cls}" onclick="assignSavedPlayer(${i}, '${esc(rp.name.replace(/'/g, "\\'"))}')">${esc(rp.name)}${gamesLabel}</button>`;
      }).join('');
      chipsHtml = `<div class="saved-players-row">${chips}</div>`;
    }

    cards += `
      <div class="player-setting-card">
        <div class="player-setting-top">
          <div class="player-setting-color" style="background:${COLORS[i].hex}"></div>
          <div class="player-setting-fields">
            <input type="text" value="${esc(p.name)}" onchange="updatePlayerName(${i}, this.value)" placeholder="Player name">
            <button class="player-setting-cmdr-btn${p.commander ? ' has-cmdr' : ''}" onclick="openCmdrSearch(${i}, true)">${cmdrContent}</button>
          </div>
        </div>
        ${chipsHtml}
      </div>`;
  });

  // Manage saved players section
  const sortedAll = [...playerRoster].sort((a, b) => b.games - a.games);
  let manageHtml = '';
  if (sortedAll.length > 0) {
    manageHtml = sortedAll.map(rp => `
      <div class="manage-player-row">
        <div>
          <span class="manage-player-name">${esc(rp.name)}</span>
          <span class="manage-player-games">${rp.games} game${rp.games !== 1 ? 's' : ''}</span>
        </div>
        <button class="manage-player-remove" onclick="removeSavedPlayer('${esc(rp.name.replace(/'/g, "\\'"))}')">‚úï</button>
      </div>`).join('');
  } else {
    manageHtml = '<div style="color:var(--text-dim);font-size:13px;padding:8px 0">No saved players yet. Type a name above or add one below!</div>';
  }

  const linkedStatus = sheetsUrl
    ? `<div class="sheets-link-status linked">‚úì Linked ‚Äî results will open this sheet every time</div>`
    : `<div class="sheets-link-status">Paste your Google Sheets URL to always export to the same sheet</div>`;

  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  const showInstall = !installDismissed && !isStandalone;
  const installHtml = showInstall ? `
    <div class="install-hint" id="installHint">
      <strong>üì± Add to Home Screen</strong> for the best experience!<br>
      Tap <strong>Share ‚Üí Add to Home Screen</strong>. Your saved players and Sheets link persist automatically.
      <button class="install-hint-dismiss" onclick="dismissInstallHint()">Got it</button>
    </div>` : '';

  document.getElementById('settingsContent').innerHTML = `
    ${installHtml}
    <div class="settings-section">
      <h3>Players & Commanders</h3>
      ${cards}
    </div>
    <div class="settings-section">
      <h3>üë• Saved Players</h3>
      <div class="manage-players-section">${manageHtml}</div>
      <div class="add-player-row">
        <input type="text" id="addPlayerInput" placeholder="Add a friend's name‚Ä¶" onkeydown="if(event.key==='Enter')addNewPlayer()">
        <button class="add-player-btn" onclick="addNewPlayer()">+ Add</button>
      </div>
    </div>
    <div class="settings-section">
      <h3>üìä Google Sheets Link</h3>
      <div class="sheets-link-section">
        <div class="sheets-link-wrap">
          <input type="text" id="sheetsUrlInput" value="${esc(sheetsUrl)}" placeholder="https://docs.google.com/spreadsheets/d/...">
          <button class="sheets-save-btn" onclick="saveSheetsUrl()">Save</button>
        </div>
        <div id="sheetsLinkStatus">${linkedStatus}</div>
      </div>
    </div>
    <div class="settings-section">
      <h3>Game Actions</h3>
      <button class="action-btn btn-winner" onclick="openWinnerModal()">üèÜ Declare Winner</button>
      <button class="action-btn btn-reset" onclick="resetGame()">‚Üª Reset Game</button>
    </div>
    <div class="settings-section">
      <h3>Game Log</h3>
      <div class="history-log">${gameState.history.length === 0 ? '<em>No events yet</em>' : gameState.history.slice(-50).map(h => `<div>[${h.time}] ${esc(h.msg)}</div>`).join('')}</div>
    </div>`;
  document.getElementById('settingsOverlay').classList.add('active');
}

function assignSavedPlayer(seatIdx, name) {
  gameState.players[seatIdx].name = name;
  renderBoard();
  openSettings(); // Re-render to update chip states
}

function addNewPlayer() {
  const input = document.getElementById('addPlayerInput');
  const name = input.value.trim();
  if (!name) return;
  addToRoster(name);
  input.value = '';
  openSettings(); // Re-render
  showToast(`${name} added!`);
}

function removeSavedPlayer(name) {
  removeFromRoster(name);
  openSettings(); // Re-render
}

function dismissInstallHint() {
  save(SK.installDismissed, true);
  const el = document.getElementById('installHint');
  if (el) el.remove();
}

function saveSheetsUrl() {
  const input = document.getElementById('sheetsUrlInput');
  sheetsUrl = input.value.trim();
  save(SK.sheetsUrl, sheetsUrl);
  const statusEl = document.getElementById('sheetsLinkStatus');
  if (sheetsUrl) {
    statusEl.innerHTML = '<div class="sheets-link-status linked">‚úì Saved! This link is remembered for all future games</div>';
    showToast('Sheet linked & saved!');
  } else {
    statusEl.innerHTML = '<div class="sheets-link-status">Link removed</div>';
  }
}

function updatePlayerName(idx, val) {
  const name = val.trim() || `Player ${idx + 1}`;
  gameState.players[idx].name = name;
  addToRoster(name); // Auto-save to roster
  renderBoard();
  openSettings(); // Refresh chips
}

// ============ WINNER + WIN CONDITION ============
let selectedWinner = null;
let selectedWinCondition = null;

function openWinnerModal() {
  closeOverlay('settingsOverlay');
  selectedWinner = null;
  selectedWinCondition = null;
  document.getElementById('winnerConfirm').classList.remove('visible');
  document.getElementById('winConditionSection').classList.remove('visible');

  const opts = document.getElementById('winnerOptions');
  opts.innerHTML = '';
  gameState.players.forEach((p, i) => {
    const btn = document.createElement('button');
    btn.className = 'winner-opt';
    btn.innerHTML = `${esc(p.name)}${p.commander ? `<div class="winner-opt-cmdr">${esc(p.commander)}</div>` : ''}`;
    btn.style.borderColor = COLORS[i].hex + '44';
    btn.onclick = () => {
      selectedWinner = i;
      document.querySelectorAll('.winner-opt').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('winConditionSection').classList.add('visible');
      updateConfirmBtn();
    };
    opts.appendChild(btn);
  });

  document.getElementById('winConditionsGrid').innerHTML = WIN_CONDITIONS.map(wc => `
    <div class="win-cond-opt" data-wc="${wc.id}" onclick="selectWinCondition('${wc.id}', this)">
      <span class="wc-icon">${wc.icon}</span>${wc.label}
    </div>`).join('');

  document.getElementById('winnerModal').classList.add('active');
}

function selectWinCondition(id, el) {
  selectedWinCondition = id;
  document.querySelectorAll('.win-cond-opt').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  updateConfirmBtn();
}

function updateConfirmBtn() {
  document.getElementById('winnerConfirm').classList.toggle('visible',
    selectedWinner !== null && selectedWinCondition !== null);
}

function confirmWinner() {
  if (selectedWinner === null || selectedWinCondition === null) return;
  gameState.winner = gameState.players[selectedWinner].name;
  gameState.winCondition = WIN_CONDITIONS.find(w => w.id === selectedWinCondition);
  logEvent(`üèÜ WINNER: ${gameState.winner} via ${gameState.winCondition.label}`);

  // Increment game counts for all players in this game
  gameState.players.forEach(p => {
    addToRoster(p.name);
    incrementRosterGames(p.name);
  });

  closeWinnerModal();
  buildExportData();
  openExportModal();
}

function closeWinnerModal() { document.getElementById('winnerModal').classList.remove('active'); }

// ============ EXPORT ============
function buildExportData() {
  const now = new Date();
  const winnerPlayer = gameState.players.find(p => p.name === gameState.winner);
  const winnerCommander = winnerPlayer ? (winnerPlayer.commander || 'N/A') : 'N/A';
  const winCondLabel = gameState.winCondition ? gameState.winCondition.label : 'N/A';
  const dateStr = `${now.getMonth()+1}/${now.getDate()}/${String(now.getFullYear()).slice(-2)}`;

  const row = [dateStr, gameState.winner, winnerCommander, winCondLabel];
  exportRowTSV = row.join('\t');

  const fullRows = [];
  fullRows.push(['Date', 'Winning Player', 'Winning Commander', 'Win Condition']);
  fullRows.push(row);
  fullRows.push([]);
  fullRows.push(['Detailed Stats']);
  fullRows.push(['Player', 'Commander', 'Color Identity', 'Final Life', 'Poison', 'Cmdr Dmg (P1)', 'Cmdr Dmg (P2)', 'Cmdr Dmg (P3)', 'Cmdr Dmg (P4)']);
  gameState.players.forEach(p => {
    const ci = p.commanderData ? (p.commanderData.color_identity || []).join('/') : '';
    fullRows.push([p.name, p.commander || 'N/A', ci || 'N/A', p.life, p.poison, ...p.cmdrDmg]);
  });
  fullRows.push([]);
  fullRows.push(['Game Log']);
  gameState.history.forEach(h => fullRows.push([h.time, h.msg]));
  exportFullCSV = fullRows.map(r => r.map(c => {
    const s = String(c);
    return s.includes(',') || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s;
  }).join(',')).join('\n');
}

function openExportModal() {
  const wc = gameState.winCondition;
  document.getElementById('exportWinnerName').textContent = `${gameState.winner} Wins!`;
  document.getElementById('exportSubtitle').textContent = wc
    ? `Victory by ${wc.icon} ${wc.label}` : 'Game data is ready to export';
  document.getElementById('exportStatus').textContent = '';
  document.getElementById('exportStatus').className = 'export-status';
  document.getElementById('exportPrimaryLabel').innerHTML = sheetsUrl
    ? 'Copy Row &amp; Open Linked Sheet' : 'Copy Row &amp; Open New Sheet';
  document.getElementById('exportModal').classList.add('active');
}

function closeExportModal() { document.getElementById('exportModal').classList.remove('active'); }

async function exportToLinkedSheet() {
  const status = document.getElementById('exportStatus');
  try {
    await navigator.clipboard.writeText(exportRowTSV);
    status.textContent = '‚úì Row copied to clipboard!';
    status.className = 'export-status success';
  } catch {
    const ta = document.createElement('textarea');
    ta.value = exportRowTSV;
    ta.style.cssText = 'position:fixed;left:-9999px';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    status.textContent = '‚úì Row copied to clipboard!';
    status.className = 'export-status success';
  }
  setTimeout(() => {
    if (sheetsUrl) {
      window.open(sheetsUrl, '_blank');
      status.textContent = '‚úì Copied! Click the next empty row & paste (Ctrl+V / ‚åòV)';
    } else {
      window.open('https://sheets.new', '_blank');
      status.textContent = '‚úì Copied! Add headers in row 1, paste data in row 2';
    }
    status.className = 'export-status success';
  }, 500);
}

function exportDownloadCSV() {
  const blob = new Blob([exportFullCSV], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `commander_game_${new Date().toISOString().slice(0, 10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  document.getElementById('exportStatus').textContent = '‚úì Full game CSV downloaded!';
  document.getElementById('exportStatus').className = 'export-status success';
}

// ============ RESET ============
function resetGame() {
  if (!confirm('Reset all life totals, counters, and history?')) return;
  gameState.players.forEach(p => { p.life = STARTING_LIFE; p.poison = 0; p.cmdrDmg = [0,0,0,0]; });
  gameState.history = [];
  gameState.startTime = new Date().toISOString();
  gameState.winner = null;
  gameState.winCondition = null;
  closeOverlay('settingsOverlay');
  renderBoard();
  showToast('Game reset!');
}

// ============ UTILS ============
function closeOverlay(id) { document.getElementById(id).classList.remove('active'); }
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}
document.addEventListener('dblclick', e => e.preventDefault());
let longPressTimer = null;
document.addEventListener('touchstart', e => {
  const btn = e.target.closest('.life-btn');
  if (!btn) return;
  longPressTimer = setTimeout(() => {
    const m = btn.getAttribute('onclick').match(/changeLife\((\d+),\s*(-?\d+)\)/);
    if (m) changeLife(parseInt(m[1]), parseInt(m[2]) * 5);
  }, 500);
}, { passive: true });
document.addEventListener('touchend', () => clearTimeout(longPressTimer), { passive: true });

renderBoard();
</script>
</body>
</html>
